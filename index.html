<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carnet dâ€™aventure</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <!-- BARRE Dâ€™EN-TÃŠTE -->
  <header class="topbar">
    <nav>
      <button class="tab-btn active">Carnet</button>
      <button class="tab-btn">Photo</button>
      <button class="tab-btn">Terrain</button>
      <button id="resetChat" class="tab-btn">Reset</button>
    </nav>
  </header>

  <!-- CARNET PRINCIPAL -->
  <main class="notebook">
    <div class="spiral"></div>
    <section class="page">
      <!-- CHAT -->
      <div id="chat" class="chatbox">
        <div class="bubble-ia">Salut, j'Ã©coute. Envoie un message quand tu veux.</div>
      </div>

      <!-- INPUT -->
      <div class="input-zone">
        <textarea id="input" placeholder="Ã‰cris un message..."></textarea>
        <button id="send">â¤</button>
      </div>
    </section>
  </main>

  <!-- PIED DE PAGE -->
  <footer class="socials">
    <a href="#" title="Facebook">ğŸ”µ</a>
    <a href="#" title="YouTube">â¤ï¸</a>
    <a href="#" title="TikTok">ğŸµ</a>
    <a href="#" title="Instagram">ğŸ“¸</a>
  </footer>

  <!-- SCRIPT GEMINI (INCHANGÃ‰) -->
  <script>
    const API_KEY = "AIza";

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const send = document.getElementById("send");

    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function appendBubble(text, who='ia', loaderId=null){
      const safe = esc(text);
      const html = who === 'user'
        ? `<div class="bubble-user">${safe}</div>`
        : `<div class="bubble-ia">${safe}</div>`;
      if(loaderId){
        const el = document.getElementById(loaderId);
        if(el) el.outerHTML = html; else chat.innerHTML += html;
      } else chat.innerHTML += html;
      chat.scrollTop = chat.scrollHeight;
    }

    async function callGeminiOfficial(prompt) {
      const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
      const payload = { contents: [ { parts: [ { text: prompt } ] } ] };

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-goog-api-key": API_KEY },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("HTTP " + res.status + " â€” " + (await res.text()));
      return res.json();
    }

    function extractText(data) {
      try {
        const parts = data.candidates?.[0]?.content?.parts;
        if (Array.isArray(parts) && parts.length > 0) {
          return parts.map(p => p.text).join("\n").trim();
        }
        return "(pas de texte)";
      } catch (e) {
        return "(erreur dâ€™extraction)";
      }
    }

    send.addEventListener("click", async () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      appendBubble(text, "user");

      const loaderId = "ldr-" + Date.now();
      chat.innerHTML += `<div id="${loaderId}" class="bubble-ia">...</div>`;
      chat.scrollTop = chat.scrollHeight;

      try {
        const data = await callGeminiOfficial(text);
        appendBubble(extractText(data), "ia", loaderId);
      } catch (err) {
        appendBubble("Erreur : " + (err.message || "Ã©chec"), "ia", loaderId);
      }
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send.click(); }
    });

    document.getElementById("resetChat").addEventListener("click", () => {
      chat.innerHTML = "";
    });
  </script>
</body>
</html>