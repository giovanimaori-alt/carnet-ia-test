<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet d'Aventurier - Interface Gemini</title>
    <!-- Chargement du CDN de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuration de la police Inter et styles personnalisés -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Style général de l'application - la "belle fenêtre" */
        .app-container {
            max-width: 40rem;
            width: 95%;
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 10, 0, 0.04);
            overflow: hidden;
        }
        /* Style pour le loader (sera utilisé plus tard) */
        .loader {
            border-top-color: #10b981;
            -webkit-animation: spinner 1s linear infinite;
            animation: spinner 1s linear infinite;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            height: 1.5rem;
            width: 1.5rem;
            display: none; /* Caché par défaut */
        }
        @keyframes spinner {
            to {transform: rotate(360deg);}
        }
        /* Style pour la zone de réponse */
        #outputArea {
            min-height: 150px;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <!-- LE CONTENEUR UNIQUE (LA BELLE FENÊTRE) -->
    <div class="app-container flex flex-col h-[80vh] sm:h-[90vh]">
        
        <!-- En-tête Intégré -->
        <header class="text-center p-6 bg-emerald-600 text-white shadow-md">
            <h1 class="text-3xl font-bold">Carnet d'Aventurier</h1>
            <p class="text-sm opacity-90 mt-1">Votre guide personnel propulsé par Gemini.</p>
             <!-- Affichage de l'état de l'utilisateur -->
            <p id="authStatus" class="text-xs mt-2 p-1 bg-emerald-700 rounded-full inline-block">
                Authentification...
            </p>
        </header>

        <!-- Zone de sortie (Conseils de l'Oracle) - HAUT et SCROLLABLE -->
        <div class="flex-grow p-6 overflow-y-auto bg-gray-100 border-b border-gray-200">
            <div id="outputArea" class="prose max-w-none text-gray-700 leading-relaxed space-y-4">
                <p class="text-gray-500 italic">Bienvenue, aventurier. Décrivez votre situation ci-dessous pour recevoir les conseils de l'Oracle.</p>
            </div>
            
            <div id="sourcesArea" class="mt-4 pt-4 border-t border-gray-100 hidden">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">Sources :</h3>
                <ul id="sourcesList" class="list-disc list-inside space-y-1 text-sm text-gray-500">
                    <!-- Les sources ou références apparaîtront ici -->
                </ul>
            </div>
        </div>


        <!-- Zone de saisie (Le Carnet) - BAS (L'input de l'utilisateur) -->
        <div class="p-4 bg-white">
            <textarea id="promptInput"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-150 resize-none"
                      rows="3"
                      placeholder="J'entre dans un donjon gardé par un dragon de glace..."></textarea>

            <div class="mt-2 flex flex-col sm:flex-row justify-end items-center">
                <div id="statusMessage" class="text-sm text-red-500 mr-4 mb-2 sm:mb-0 hidden"></div>
                <button id="generateButton"
                        class="w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-200 flex items-center justify-center"
                        onclick="generateContent()"
                        disabled>
                    <span id="buttonText">Lancer l'Analyse</span>
                    <div id="loader" class="loader ml-2"></div>
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase references
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        // Ajout d'un drapeau pour vérifier l'état de Firebase
        window.isFirebaseInitialized = false; 

        // Global utility variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const authStatusElement = document.getElementById('authStatus');
        const promptInput = document.getElementById('promptInput');
        const generateButton = document.getElementById('generateButton');

        // --- Fonctions Firestore (Connexion/Sauvegarde/Chargement) ---

        // 1. Sauvegarde de la dernière requête de l'utilisateur
        window.saveLastQuery = async (query) => {
            if (!window.userId || !window.db || !window.isFirebaseInitialized) {
                console.warn("Firestore non prêt pour la sauvegarde. Données non persistées.");
                return;
            }

            const userDocRef = doc(window.db, "artifacts", appId, "users", window.userId, "settings", "last_adventure_prompt");
            try {
                // Sauvegarde de la requête actuelle
                await setDoc(userDocRef, { lastQuery: query, timestamp: Date.now() }, { merge: true });
                console.log("Requête sauvegardée pour l'utilisateur:", window.userId);
            } catch (e) {
                console.error("Erreur lors de la sauvegarde de la requête:", e);
            }
        };

        // 2. Chargement de la dernière requête
        const loadLastQuery = async () => {
            if (!window.userId || !window.db || !window.isFirebaseInitialized) return;

            const userDocRef = doc(window.db, "artifacts", appId, "users", window.userId, "settings", "last_adventure_prompt");
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.lastQuery) {
                        promptInput.value = data.lastQuery;
                        // Activer le bouton après le chargement si le champ n'est pas vide
                        if (promptInput.value.trim() !== '') {
                            generateButton.disabled = false;
                        }
                        console.log("Dernière requête chargée:", data.lastQuery);
                    }
                }
            } catch (e) {
                console.error("Erreur lors du chargement de la requête:", e);
            }
        };

        // --- Initialisation Firebase et Authentification ---
        window.onload = function() {
            try {
                // Vérifier si la config est vide, si oui, ne pas initialiser Firebase pour éviter l'erreur critique.
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("La configuration Firebase est vide. L'application fonctionnera sans connexion.");
                }

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                window.isFirebaseInitialized = true;
                console.log("Firebase initialisé.");

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        authStatusElement.textContent = `Connecté. ID Utilisateur: ${window.userId}`;
                        window.isAuthReady = true;
                        loadLastQuery(); 
                    } else {
                        authStatusElement.textContent = "Connexion...";
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                        } catch (e) {
                            console.error("Échec de l'authentification:", e);
                            authStatusElement.textContent = "Échec d'Auth. (Sauvegarde désactivée)";
                            window.isAuthReady = true; 
                            window.userId = crypto.randomUUID(); // Utiliser un ID aléatoire si Auth échoue pour la persistance locale
                        }
                    }
                });

            } catch (e) {
                // Bloc de gestion de l'erreur Firebase: l'application peut continuer sans persistance
                console.error("Erreur critique d'initialisation de Firebase/Firestore:", e);
                authStatusElement.textContent = "Mode local actif. (Sauvegarde désactivée)";
                window.isAuthReady = true; // L'application est prête à fonctionner (sans Auth/Firestore)
                window.isFirebaseInitialized = false;
            } finally {
                // Écouteur pour activer/désactiver le bouton même si Firebase échoue
                promptInput.addEventListener('input', function() {
                    generateButton.disabled = this.value.trim() === '';
                });

                // S'assurer que le bouton est actif si l'Auth est prête (ou non nécessaire)
                if (promptInput.value.trim() !== '') {
                    generateButton.disabled = false;
                }
            }
        };
    </script>

    <!-- Script de Logique de l'Assistant (Non-module pour les fonctions globales) -->
    <script>
        // --- Fonction utilitaire pour le backoff exponentiel ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        const errorText = await response.text();
                        throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    console.error(`Erreur lors de la requête (tentative ${i + 1}/${maxRetries}):`, error);
                }
            }
        }

        // --- Logique du PROMPT SYSTÈME ---
        function getSystemInstruction() {
            // Utiliser un rôle clair et simple pour le test initial.
            const tempPrompt = `
            Tu es l'Oracle du Carnet d'Aventurier. Ton rôle est d'apporter des conseils de survie et des options tactiques à l'utilisateur, qui est un aventurier dans un monde fantastique.
            Réponds toujours avec un ton mystique et motivant, en proposant trois (3) actions claires.
            `.trim();
            return tempPrompt;
        }

        // --- Fonction principale d'exécution de l'Assistant ---
        window.generateContent = async function() {
            const promptInput = document.getElementById('promptInput');
            const outputArea = document.getElementById('outputArea');
            const statusMessage = document.getElementById('statusMessage');
            const loader = document.getElementById('loader');
            const generateButton = document.getElementById('generateButton');
            const sourcesArea = document.getElementById('sourcesArea');
            const sourcesList = document.getElementById('sourcesList');

            if (!window.isAuthReady || generateButton.disabled) {
                statusMessage.textContent = 'Veuillez attendre que l\'application soit prête et entrer une requête.';
                statusMessage.classList.remove('hidden');
                return;
            }

            const userQuery = promptInput.value.trim();

            // Préparation de l'interface
            outputArea.innerHTML = '<p class="text-gray-500 italic">Analyse en cours...</p>';
            statusMessage.classList.add('hidden');
            sourcesArea.classList.add('hidden');
            sourcesList.innerHTML = '';
            
            // Activation du chargement
            loader.style.display = 'inline-block';
            generateButton.disabled = true;

            try {
                // 1. Sauvegarde de la requête avant l'appel (si Firebase est initialisé)
                await window.saveLastQuery(userQuery);

                const systemInstruction = getSystemInstruction();

                const apiKey = ""; 
                // CORRECTION ICI : L'URL de l'API est construite correctement sur une seule ligne
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // IMPORTANT : Active la recherche Google pour que l'IA puisse utiliser des données récentes
                    tools: [{ "google_search": {} }], 
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    // Utiliser le même formatage simple que dans le fichier original
                    outputArea.innerHTML = `<p>${text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</p>`; 

                    // Traitement et affichage des sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        let sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        if (sources.length > 0) {
                            sources.forEach((source, index) => {
                                const li = document.createElement('li');
                                li.innerHTML = `<a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">${source.title}</a>`;
                                sourcesList.appendChild(li);
                            });
                            sourcesArea.classList.remove('hidden');
                        }
                    }

                    statusMessage.textContent = 'Analyse terminée.';
                    statusMessage.className = 'text-sm text-green-600 mr-4 mb-2 sm:mb-0';

                } else {
                    outputArea.innerHTML = '<p class="text-red-500">Erreur : Impossible de recevoir les conseils de l\'Oracle. (Réponse vide)</p>';
                    statusMessage.textContent = 'Échec de l\'analyse.';
                    statusMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Erreur critique lors de l'appel API:", error);
                outputArea.innerHTML = `<p class="text-red-500">Erreur critique : ${error.message}</p>`;
                statusMessage.textContent = 'Erreur réseau.';
                statusMessage.classList.remove('hidden');
            } finally {
                loader.style.display = 'none';
                generateButton.disabled = false;
            }
        }
    </script>
</body>
</html>


‎Gemini - Carnet d'Aventurier - Interface Gemini
‎Gemini - Carnet d'Aventurier - Interface Gemini
‎Gemini - Carnet d'Aventurier - Interface Gemini
‎Gemini - Carnet d'Aventurier - Interface Gemini
